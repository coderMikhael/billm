<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AT&T Billing – Main Page</title>
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  /* Light + aesthetic + gaming (neon accent) */
  :root{
    --bg:#f5f7fa;
    --bg-accent: radial-gradient(1200px 1200px at 10% -10%, rgba(155,81,224,.18), transparent 40%),
                 radial-gradient(1000px 800px at 100% 0%, rgba(78,161,255,.16), transparent 40%),
                 radial-gradient(900px 900px at 50% 100%, rgba(255,105,180,.10), transparent 35%);
    --card:#ffffff;
    --muted:#5b6472;
    --text:#0d1117;
    --accent:#7c3aed;   /* violet neon */
    --accent-2:#00d4ff; /* cyan neon */
    --ok:#16a34a;
    --warn:#eab308;
    --danger:#ef4444;
    --border:#e6e9ef;
    --shadow: 0 8px 24px rgba(17,17,26,.05), 0 2px 6px rgba(17,17,26,.04);
    --radius: 14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:14px/1.5 "Outfit", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: var(--bg);
    background-image: var(--bg-accent);
    background-attachment: fixed;
  }

  .wrap{max-width:1120px;margin:0 auto;padding:26px}
  .pill{
    padding:6px 10px;border-radius:999px;background:#fff;
    border:1px solid var(--border); color:#374151;
    box-shadow: var(--shadow);
  }
  .muted{color:var(--muted)} .dim{opacity:.85}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .bar{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px
  }
  .spacer{flex:1}

  h1{
    font-size:20px;margin:0 0 6px;
    letter-spacing:.2px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    -webkit-background-clip: text; background-clip: text; color: transparent;
    text-shadow: 0 0 0 rgba(0,0,0,0);
  }
  h2{font-size:15px;margin:0 0 10px;color:#374151}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    box-shadow: var(--shadow);
    backdrop-filter: saturate(1.2);
  }

  label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

  input[type="text"],input[type="number"],input[type="month"]{
    width:100%; background:#fbfcff; border:1px solid var(--border);
    border-radius:12px; color:var(--text); padding:10px 12px; outline:none;
    transition: box-shadow .15s ease, border-color .15s ease, transform .06s ease;
  }
  input[type="number"]{appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(124,58,237,.15), 0 0 0 1px var(--accent) inset;
  }

  button{
    background:#fff; color:#111827; border:1px solid var(--border);
    padding:10px 14px; border-radius:12px; cursor:pointer;
    box-shadow: var(--shadow);
    transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(17,17,26,.08), 0 3px 8px rgba(17,17,26,.06); }
  button:active{ transform: translateY(0) scale(.98); }

  button.primary{
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    border-color: transparent; color:white; font-weight:600;
    text-shadow: 0 1px 0 rgba(0,0,0,.12);
  }
  button.ghost{background:rgba(255,255,255,.8)}
  button.warn{background:#fff7e6;border-color:#fde68a;color:#9a6700}
  button.danger{background:#fff1f2;border-color:#fecdd3;color:#b91c1c}

  table{
    width:100%; border-collapse:separate; border-spacing:0;
    border:1px solid var(--border); border-radius:16px; overflow:hidden;
    background:#fff;
  }
  thead th{
    position:sticky; top:0; background:linear-gradient(180deg,#fafbff,#f3f6ff);
    border-bottom:1px solid var(--border); font-weight:600; padding:12px; text-align:left;
  }
  tbody td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle}
  tbody tr:last-child td{border-bottom:none}
  tbody tr:hover{background:#fafcff}

  td.center,th.center{text-align:center}

  /* compact money inputs, let notes breathe */
  .money{width:92px}
  .phone{width:170px}
  .notes{min-width:320px}

  .totals{display:flex;gap:16px;justify-content:flex-end;margin-top:12px}
  .totals .pill{background:#fff}

  /* subtle neon focus ring utility for gaming vibe */
  .neon{
    box-shadow: 0 0 0 3px rgba(0,212,255,.15), 0 0 18px rgba(124,58,237,.24);
    border-color: transparent !important;
  }

  /* Modal shell (config) */
  .modal-backdrop{position:fixed;inset:0;background:rgba(10,12,16,.35);display:none;align-items:center;justify-content:center;z-index:20;backdrop-filter: blur(3px)}
  .modal{width:min(980px,95vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow: var(--shadow)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
</style>

</head>
<body>
<div class="wrap">
  <div class="bar">
    <h1>AT&amp;T Billing (Main Page)</h1>
    <span id="cycleLabel" class="pill"></span>
    <span id="todayLabel" class="pill muted"></span>
    <div class="spacer"></div>
    <button id="configBtn" class="ghost dim" title="Configure people">Config</button>
    <button id="prevCycleBtn" class="ghost">◀ Prev</button>
    <button id="nextCycleBtn" class="ghost">Next ▶</button>
    <button id="saveWebBtn" class="primary">Save to Web</button>
  </div>

  <div class="card" style="margin-bottom:14px">
    <h2>Bill</h2>
    <label class="small">Bill Amount (for this cycle)</label>
    <input id="billAmount" type="number" step="0.01" min="0" placeholder="0.00" class="money" />
  </div>

  <div class="card">
    <h2 style="margin-bottom:10px">Lines (from Config &amp; dates)</h2>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th class="center">Informed?</th>
            <th>Sr_no</th>
            <th>Name</th>
            <th>Ph_no</th>
            <th>Amount</th>
            <th>Previous Due</th>
            <th>Balance_due</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="totals">
      <span class="pill">Total Amount: <b id="totalAmount">0.00</b></span>
      <span class="pill">Total Balance Due: <b id="totalDue">0.00</b></span>
    </div>
  </div>
</div>

<!-- Config Modal -->
<div id="configModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 style="margin:0">Config – People</h2>
      <button id="cfgClose" class="ghost">✕</button>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="cfgAdd" class="ghost">+ Add Person</button>
      <span class="muted">Active when <b>Archive_month/year</b> is empty and cycle ≥ <b>Active_month/year</b>. “Archive → next” sets archive to the <b>next cycle</b>.</span>
    </div>

    <div class="sectionTitle">Active</div>
    <div style="overflow:auto; max-height:34vh;">
      <table>
        <thead>
          <tr>
            <th>Sr_No</th>
            <th>Name</th>
            <th>Ph_No</th>
            <th>Active_month/year</th>
            <th>Archive_month/year</th>
            <th class="center">Archive → next</th>
            <th class="center">Delete</th>
          </tr>
        </thead>
        <tbody id="cfgActiveBody"></tbody>
      </table>
    </div>

    <div class="sectionTitle">Archived</div>
    <div style="overflow:auto; max-height:34vh;">
      <table>
        <thead>
          <tr>
            <th>Sr_No</th>
            <th>Name</th>
            <th>Ph_No</th>
            <th>Active_month/year</th>
            <th>Archive_month/year</th>
            <th class="center">Delete</th>
          </tr>
        </thead>
        <tbody id="cfgArchivedBody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="cfgSave" class="primary">Done</button>
    </div>
  </div>
</div>

<script>
/* ===== EDIT THESE for “Save to Web” (2 files) ===== */
const OWNER       = 'your-github-username';
const REPO        = 'your-github-pages-repo';
const BRANCH      = 'gh-pages';                 // or 'main'
const PATH_STATE  = 'data/att-billing.json';    // cycles: amounts/balances/notes
const PATH_CONFIG = 'data/att-config.json';     // central people config
const TOKEN       = 'ghp_xxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxxx';
/* ================================================ */

const STORAGE_STATE  = 'att.billing.state.v10';
const STORAGE_CONFIG = 'att.billing.config.v6';
const FILE_SCHEMA_VERSION = 1;

/* ---- Cycle helpers (10th → 9th) ---- */
function pad(n){ return String(n).padStart(2,'0'); }
function keyFromDate(d=new Date()){
  let y=d.getFullYear(), m=d.getMonth(), day=d.getDate();
  if(day < 10){ m -= 1; if(m<0){ m=11; y-=1; } }
  return `${y}-${pad(m+1)}`;
}
function startFromKey(key){ const [y,m]=key.split('-').map(Number); return new Date(y, m-1, 10); }
function nextKey(key){ const s=startFromKey(key); const n=new Date(s.getFullYear(), s.getMonth()+1, 10); return `${n.getFullYear()}-${pad(n.getMonth()+1)}`; }
function prevKey(key){ const s=startFromKey(key); const p=new Date(s.getFullYear(), s.getMonth()-1, 10); return `${p.getFullYear()}-${pad(p.getMonth()+1)}`; }
function rangeFromKey(key){ const s=startFromKey(key); const e=new Date(s.getFullYear(), s.getMonth()+1, 9); return [s,e]; }
function fmtDate(dt){ return dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }

/* ---- Data shapes ----
STATE.json  { version, cycles:{ [key]: { billAmount, rows:[ {personKey, informed, amount, prevDue, balance, notes, _prevFromKey?} ] } } }
CONFIG.json { version, people:[ {sr_no, name, phone, activeFrom:'YYYY-MM', archiveFrom:'YYYY-MM'|null} ] }
personKey = phone (must be unique for each person)
-------------------------------------------------------- */
function newState(){ return { version:FILE_SCHEMA_VERSION, cycles:{} }; }
function newConfig(){ return { version:FILE_SCHEMA_VERSION, people:[] }; }

let STATE  = loadJSON(STORAGE_STATE)  || newState();
let CONFIG = loadJSON(STORAGE_CONFIG) || newConfig();
let CURRENT_KEY = keyFromDate(new Date());

/* ---- Storage ---- */
function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch{return null} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ---- GitHub Contents API ---- */
async function repoGetFile(ownerRepo, path, branch){
  const res = await fetch(`https://api.github.com/repos/${ownerRepo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, {
    headers: TOKEN ? {Authorization:'Bearer '+TOKEN, Accept:'application/vnd.github+json'} : {Accept:'application/vnd.github+json'}
  });
  if(res.status===404) return null;
  if(!res.ok){
    const j = await res.json().catch(()=>({}));
    throw new Error((j.message||'HTTP '+res.status));
  }
  return res.json();
}
async function repoPutFile(ownerRepo, path, branch, content, sha, message){
  const body = {
    message: message || 'Update ATT billing data',
    content: btoa(unescape(encodeURIComponent(content))),
    branch
  };
  if(sha) body.sha = sha;
  const res = await fetch(`https://api.github.com/repos/${ownerRepo}/contents/${encodeURIComponent(path)}`, {
    method:'PUT',
    headers: {Authorization:'Bearer '+TOKEN, Accept:'application/vnd.github+json'},
    body: JSON.stringify(body)
  });
  if(!res.ok){
    const j = await res.json().catch(()=>({}));
    throw new Error((j.message||'HTTP '+res.status));
  }
  return res.json();
}

/* ---- DOM ---- */
const el = {
  cycleLabel: document.getElementById('cycleLabel'),
  todayLabel: document.getElementById('todayLabel'),
  billAmount: document.getElementById('billAmount'),
  tbody:      document.getElementById('tbody'),
  totalAmount:document.getElementById('totalAmount'),
  totalDue:   document.getElementById('totalDue'),
  prevCycleBtn: document.getElementById('prevCycleBtn'),
  nextCycleBtn: document.getElementById('nextCycleBtn'),
  saveWebBtn: document.getElementById('saveWebBtn'),
  // config
  configBtn:  document.getElementById('configBtn'),
  configModal:document.getElementById('configModal'),
  cfgClose:   document.getElementById('cfgClose'),
  cfgAdd:     document.getElementById('cfgAdd'),
  cfgActiveBody:   document.getElementById('cfgActiveBody'),
  cfgArchivedBody: document.getElementById('cfgArchivedBody'),
  cfgSave:    document.getElementById('cfgSave'),
};

/* ---- Rules ---- */
// active if: started <= key AND (no archiveFrom OR key < archiveFrom)
function personActiveInCycle(p, key){
  const aFrom = p.activeFrom || '0000-01';
  const aStop = p.archiveFrom || null;
  const started = (aFrom <= key);
  const notStopped = (aStop === null) || (key < aStop); // disappear starting archiveFrom
  return started && notStopped;
}

function prevCycleKey(key){ return prevKey(key); }

/* Build cycle rows from CONFIG; keep amounts; compute prevDue default from prev cycle */
function ensureCycleRowsFromConfig(key){
  if(!STATE.cycles[key]) STATE.cycles[key] = { billAmount:0, rows:[] };

  const prevMap = Object.fromEntries((STATE.cycles[key].rows||[]).map(r=>[r.personKey, r]));

  const activePeopleOrdered = (CONFIG.people||[])
    .filter(p=>personActiveInCycle(p, key))
    .sort((a,b)=>(Number(a.sr_no||0)-Number(b.sr_no||0)));

  const rows = activePeopleOrdered.map((p)=>{
    const pk = (p.phone||'').trim(); // PHONE is the key (make unique)
    const existing = prevMap[pk] || {};
    let prevDue = existing.prevDue;

    const wantPrevKey = prevCycleKey(key);
    if(prevDue === undefined || existing._prevFromKey !== wantPrevKey){
      const prevRows = (STATE.cycles[wantPrevKey]?.rows)||[];
      const prevRow = prevRows.find(rr => rr.personKey === pk);
      prevDue = prevRow ? Number(prevRow.balance||0) : 0;
    }

    const amount = existing.amount ?? 0;
    const balance = Number(amount||0) + Number(prevDue||0);

    return {
      personKey: pk,
      informed: !!existing.informed,
      amount: Number(amount||0),
      prevDue: Number(prevDue||0),
      balance: Number(balance||0),
      notes: existing.notes || '',
      _prevFromKey: wantPrevKey
    };
  });

  STATE.cycles[key].rows = rows;
}

/* ---- Render main ---- */
function render(){
  const [s,e] = rangeFromKey(CURRENT_KEY);
  el.cycleLabel.textContent = `Cycle ${fmtDate(s)} – ${fmtDate(e)} (${CURRENT_KEY})`;
  el.todayLabel.textContent = `Today: ${fmtDate(new Date())}`;

  ensureCycleRowsFromConfig(CURRENT_KEY);

  el.billAmount.value = STATE.cycles[CURRENT_KEY].billAmount ?? 0;

  renderRows();
  updateTotals();
}

function renderRows(){
  const cycle = STATE.cycles[CURRENT_KEY] || {rows:[]};
  const rows = cycle.rows;

  // join with CONFIG by phone
  const byPhone = Object.create(null);
  (CONFIG.people||[]).forEach(p=>{ byPhone[(p.phone||'').trim()] = p; });

  el.tbody.innerHTML = '';
  rows.forEach((r, i)=>{
    const p = byPhone[r.personKey] || {};
    const tr = document.createElement('tr');

    // Informed
    const tdInf = document.createElement('td'); tdInf.className='center';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!r.informed;
    cb.addEventListener('change', ()=>{ r.informed=cb.checked; saveJSON(STORAGE_STATE, STATE); });
    tdInf.appendChild(cb);

    // Sr_no sequential
    const tdSr  = document.createElement('td'); tdSr.textContent = String(i+1);

    // Name / Phone (read-only display)
    const tdNm  = document.createElement('td'); tdNm.textContent = p.name || '';
    const tdPh  = document.createElement('td'); tdPh.textContent = p.phone || r.personKey || '';

    // Amount
    const tdAmt = document.createElement('td');
    const amt = document.createElement('input'); amt.type='number'; amt.step='0.01'; amt.min='0'; amt.className='money'; amt.value=r.amount ?? 0;
    amt.addEventListener('input', ()=>{ r.amount=parseFloat(amt.value||'0'); r.balance = Number(r.amount||0)+Number(r.prevDue||0); saveJSON(STORAGE_STATE, STATE); updateTotals(); });
    tdAmt.appendChild(amt);

    // Previous Due (auto-filled; editable)
    const tdPrev = document.createElement('td');
    const pd = document.createElement('input'); pd.type='number'; pd.step='0.01'; pd.min='0'; pd.className='money'; pd.value=r.prevDue ?? 0;
    pd.addEventListener('input', ()=>{ r.prevDue=parseFloat(pd.value||'0'); r.balance = Number(r.amount||0)+Number(r.prevDue||0); saveJSON(STORAGE_STATE, STATE); updateTotals(); });
    tdPrev.appendChild(pd);

    // Balance Due (read-only; amount + prevDue)
    const tdBal = document.createElement('td');
    const bal = document.createElement('input'); bal.type='number'; bal.step='0.01'; bal.min='0'; bal.className='money'; bal.value=r.balance ?? 0; bal.readOnly = true;
    const syncBal = ()=>{ bal.value = (Number(r.amount||0)+Number(r.prevDue||0)).toFixed(2); };
    syncBal();
    tdBal.appendChild(bal);

    // Notes (wide)
    const tdNt  = document.createElement('td');
    const nt = document.createElement('input'); nt.type='text'; nt.className='notes'; nt.placeholder='Notes'; nt.value=r.notes||'';
    nt.addEventListener('input', ()=>{ r.notes=nt.value; saveJSON(STORAGE_STATE, STATE); });
    tdNt.appendChild(nt);

    tr.append(tdInf, tdSr, tdNm, tdPh, tdAmt, tdPrev, tdBal, tdNt);
    el.tbody.appendChild(tr);
  });
}

function updateTotals(){
  const rows = STATE.cycles[CURRENT_KEY].rows || [];
  const totAmt = rows.reduce((s,r)=>s+Number(r.amount||0),0);
  rows.forEach(r=>{ r.balance = Number(r.amount||0)+Number(r.prevDue||0); });
  const totDue = rows.reduce((s,r)=>s+Number(r.balance||0),0);
  el.totalAmount.textContent = totAmt.toFixed(2);
  el.totalDue.textContent    = totDue.toFixed(2);
}

/* ---- Events: main ---- */
el.billAmount.addEventListener('input', ()=>{
  if(!STATE.cycles[CURRENT_KEY]) STATE.cycles[CURRENT_KEY]={billAmount:0, rows:[]};
  STATE.cycles[CURRENT_KEY].billAmount = parseFloat(el.billAmount.value||'0');
  saveJSON(STORAGE_STATE, STATE);
});
el.prevCycleBtn.addEventListener('click', ()=>{
  CURRENT_KEY = prevKey(CURRENT_KEY);
  if(!STATE.cycles[CURRENT_KEY]) STATE.cycles[CURRENT_KEY]={billAmount:0, rows:[]};
  ensureCycleRowsFromConfig(CURRENT_KEY);
  saveJSON(STORAGE_STATE, STATE);
  render();
});
el.nextCycleBtn.addEventListener('click', ()=>{
  CURRENT_KEY = nextKey(CURRENT_KEY);
  if(!STATE.cycles[CURRENT_KEY]) STATE.cycles[CURRENT_KEY]={billAmount:0, rows:[]};
  ensureCycleRowsFromConfig(CURRENT_KEY);
  saveJSON(STORAGE_STATE, STATE);
  render();
});

/* ---- Config Modal ---- */
el.configBtn.addEventListener('click', ()=>{ renderConfigTables(); el.configModal.style.display='flex'; });
el.cfgClose.addEventListener('click', ()=> el.configModal.style.display='none');
el.cfgSave.addEventListener('click', ()=>{
  saveJSON(STORAGE_CONFIG, CONFIG);
  ensureCycleRowsFromConfig(CURRENT_KEY);
  saveJSON(STORAGE_STATE, STATE);
  render();
  el.configModal.style.display='none';
});
el.cfgAdd.addEventListener('click', ()=>{
  CONFIG.people.push({
    sr_no: (CONFIG.people.length+1),  // Active will render as 1..N
    name:'', phone:'',
    activeFrom: keyFromDate(new Date()),
    archiveFrom: null
  });
  saveJSON(STORAGE_CONFIG, CONFIG);
  renderConfigTables();
});

function renderConfigTables(){
  const active = [], archived = [];
  (CONFIG.people||[]).forEach(p => (p.archiveFrom ? archived : active).push(p));
  active.sort((a,b)=>(Number(a.sr_no||0)-Number(b.sr_no||0)));

  el.cfgActiveBody.innerHTML = '';
  el.cfgArchivedBody.innerHTML = '';

  // ACTIVE: 1..N (no gaps)
  active.forEach((p, idx)=>{
    const tr = document.createElement('tr');

    const tdSr = document.createElement('td'); tdSr.textContent = String(idx+1); tr.appendChild(tdSr);

    tr.appendChild(cfgTextCell(p, 'name', 'Full name'));
    tr.appendChild(cfgTextCell(p, 'phone', '555-123-4567', 'phone'));

    tr.appendChild(cfgMonthCell(p, 'activeFrom'));
    tr.appendChild(cfgMonthCell(p, 'archiveFrom', ()=>{ renderConfigTables(); }));

    // Archive → set next cycle
    const tdArc = document.createElement('td'); tdArc.className='center';
    const ab = document.createElement('button'); ab.textContent='Archive'; ab.className='warn';
    ab.title='Move to Archived (from next cycle)';
    ab.addEventListener('click', ()=>{
      p.archiveFrom = nextKey(CURRENT_KEY); // change to CURRENT_KEY to hide immediately
      saveJSON(STORAGE_CONFIG, CONFIG);
      renderConfigTables();
      ensureCycleRowsFromConfig(CURRENT_KEY);
      saveJSON(STORAGE_STATE, STATE);
      render();
    });
    tdArc.appendChild(ab);
    tr.appendChild(tdArc);

    // Delete person
    const tdDel = document.createElement('td'); tdDel.className='center';
    const db = document.createElement('button'); db.textContent='Delete'; db.className='danger';
    db.title='Remove from config (history stays in past cycles)';
    db.addEventListener('click', ()=>{
      if(confirm(`Delete ${p.name || p.phone || 'this person'} from config? This does not change past cycles.`)){
        const i = CONFIG.people.indexOf(p);
        if(i>=0){ CONFIG.people.splice(i,1); saveJSON(STORAGE_CONFIG, CONFIG); renderConfigTables(); ensureCycleRowsFromConfig(CURRENT_KEY); saveJSON(STORAGE_STATE, STATE); render(); }
      }
    });
    tdDel.appendChild(db);
    tr.appendChild(tdDel);

    el.cfgActiveBody.appendChild(tr);
  });

  // ARCHIVED: its own 1..M numbering + delete
  archived.forEach((p, idx)=>{
    const tr = document.createElement('tr');
    const tdSr = document.createElement('td'); tdSr.textContent = String(idx+1); tr.appendChild(tdSr);

    tr.appendChild(cfgTextCell(p, 'name', 'Full name'));
    tr.appendChild(cfgTextCell(p, 'phone', '555-123-4567', 'phone'));
    tr.appendChild(cfgMonthCell(p, 'activeFrom'));
    tr.appendChild(cfgMonthCell(p, 'archiveFrom', ()=>{ renderConfigTables(); }));

    const tdDel = document.createElement('td'); tdDel.className='center';
    const db = document.createElement('button'); db.textContent='Delete'; db.className='danger';
    db.title='Remove from config (history stays in past cycles)';
    db.addEventListener('click', ()=>{
      if(confirm(`Delete ${p.name || p.phone || 'this person'} from config? This does not change past cycles.`)){
        const i = CONFIG.people.indexOf(p);
        if(i>=0){ CONFIG.people.splice(i,1); saveJSON(STORAGE_CONFIG, CONFIG); renderConfigTables(); ensureCycleRowsFromConfig(CURRENT_KEY); saveJSON(STORAGE_STATE, STATE); render(); }
      }
    });
    tdDel.appendChild(db);
    tr.appendChild(tdDel);

    el.cfgArchivedBody.appendChild(tr);
  });
}

// tiny inline “cells”
function cfgTextCell(obj, key, placeholder, cls){
  const td = document.createElement('td');
  const inp = document.createElement('input');
  inp.type='text'; if(cls) inp.className=cls;
  inp.placeholder = placeholder || '';
  inp.value = obj[key] || '';
  inp.addEventListener('input', ()=>{ obj[key]=inp.value; saveJSON(STORAGE_CONFIG, CONFIG); });
  td.appendChild(inp);
  return td;
}
function cfgMonthCell(obj, key, onChange){
  const td = document.createElement('td');
  const m = document.createElement('input'); m.type='month'; m.value=(obj[key]||'').slice(0,7);
  m.addEventListener('input', ()=>{
    obj[key] = m.value || null;
    saveJSON(STORAGE_CONFIG, CONFIG);
    if(onChange) onChange();
  });
  td.appendChild(m);
  return td;
}

/* ---- Save to Web (two files) ---- */
async function saveToWeb(){
  if(!OWNER || !REPO || !BRANCH || !TOKEN){ alert('Fill OWNER/REPO/BRANCH/TOKEN at top.'); return; }
  const ownerRepo = `${OWNER}/${REPO}`;
  // STATE
  let shaState = null;
  try{ const j = await repoGetFile(ownerRepo, PATH_STATE, BRANCH); if(j && j.sha) shaState=j.sha; }catch{}
  await repoPutFile(ownerRepo, PATH_STATE, BRANCH, JSON.stringify(STATE,null,2), shaState, 'Save ATT billing (state)');
  // CONFIG
  let shaCfg = null;
  try{ const j2 = await repoGetFile(ownerRepo, PATH_CONFIG, BRANCH); if(j2 && j2.sha) shaCfg=j2.sha; }catch{}
  await repoPutFile(ownerRepo, PATH_CONFIG, BRANCH, JSON.stringify(CONFIG,null,2), shaCfg, 'Save ATT billing (config)');
  alert('Saved to web JSON ✅');
}
el.saveWebBtn.addEventListener('click', ()=> saveToWeb().catch(e=>alert('Save failed: '+e.message)));

/* ---- Initial load from Web if present ---- */
async function tryLoadFromWebOnce(){
  if(!OWNER || !REPO || !BRANCH) return;
  const ownerRepo = `${OWNER}/${REPO}`;
  try{
    const st = await repoGetFile(ownerRepo, PATH_STATE, BRANCH);
    if(st?.content){
      const s = JSON.parse(decodeURIComponent(escape(atob(st.content))));
      if(s.version===FILE_SCHEMA_VERSION) STATE = s;
    }
  }catch{}
  try{
    const cf = await repoGetFile(ownerRepo, PATH_CONFIG, BRANCH);
    if(cf?.content){
      const c = JSON.parse(decodeURIComponent(escape(atob(cf.content))));
      if(c.version===FILE_SCHEMA_VERSION) CONFIG = c;
    }
  }catch{}
  if((CONFIG.people||[]).length===0){ CONFIG.people = []; }
  if(!STATE.cycles[CURRENT_KEY]) STATE.cycles[CURRENT_KEY]={billAmount:0, rows:[]};
  ensureCycleRowsFromConfig(CURRENT_KEY);
  saveJSON(STORAGE_STATE, STATE);
  saveJSON(STORAGE_CONFIG, CONFIG);
}

/* ---- Boot ---- */
(async function init(){
  await tryLoadFromWebOnce();
  render();
})();
</script>
</body>
</html>
