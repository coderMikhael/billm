<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>AT&T Billing</title>

<!-- Light + aesthetic + gaming font -->
<link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600&display=swap" rel="stylesheet">

<style>
  /* Light + aesthetic + gaming (neon accent) */
  :root{
    --bg:#f5f7fa;
    --bg-accent: radial-gradient(1200px 1200px at 10% -10%, rgba(155,81,224,.18), transparent 40%),
                 radial-gradient(1000px 800px at 100% 0%, rgba(78,161,255,.16), transparent 40%),
                 radial-gradient(900px 900px at 50% 100%, rgba(255,105,180,.10), transparent 35%);
    --card:#ffffff;
    --muted:#5b6472;
    --text:#0d1117;
    --accent:#7c3aed;   /* violet neon */
    --accent-2:#00d4ff; /* cyan neon */
    --warn:#eab308;
    --danger:#ef4444;
    --border:#e6e9ef;
    --shadow: 0 8px 24px rgba(17,17,26,.05), 0 2px 6px rgba(17,17,26,.04);
    --radius: 14px;
  }

  *{box-sizing:border-box}
  html,body{height:100%}
  body{
    margin:0; color:var(--text);
    font:14px/1.5 "Outfit", system-ui, -apple-system, Segoe UI, Roboto, Arial;
    background: var(--bg);
    background-image: var(--bg-accent);
    background-attachment: fixed;
  }

  .wrap{max-width:1120px;margin:0 auto;padding:26px}
  .pill{
    padding:6px 10px;border-radius:999px;background:#fff;
    border:1px solid var(--border); color:#374151;
    box-shadow: var(--shadow);
  }
  .muted{color:var(--muted)} .dim{opacity:.85}

  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .bar{
    display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:16px
  }
  .spacer{flex:1}

  h1{
    font-size:20px;margin:0 0 6px;
    letter-spacing:.2px;
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    -webkit-background-clip: text; background-clip: text; color: transparent;
  }
  h2{font-size:15px;margin:0 0 10px;color:#374151}

  .card{
    background:var(--card);
    border:1px solid var(--border);
    border-radius:var(--radius);
    padding:16px;
    box-shadow: var(--shadow);
    backdrop-filter: saturate(1.2);
  }

  label.small{font-size:12px;color:var(--muted);display:block;margin-bottom:6px}

  input[type="text"],input[type="number"],input[type="month"],input[type="date"]{
    width:100%; background:#fbfcff; border:1px solid var(--border);
    border-radius:12px; color:var(--text); padding:10px 12px; outline:none;
    transition: box-shadow .15s ease, border-color .15s ease, transform .06s ease;
  }
  input[type="number"]{appearance:textfield}
  input::-webkit-outer-spin-button,input::-webkit-inner-spin-button{-webkit-appearance:none;margin:0}
  input:focus{
    border-color: var(--accent);
    box-shadow: 0 0 0 4px rgba(124,58,237,.15), 0 0 0 1px var(--accent) inset;
  }

  button{
    background:#fff; color:#111827; border:1px solid var(--border);
    padding:10px 14px; border-radius:12px; cursor:pointer;
    box-shadow: var(--shadow);
    transition: transform .06s ease, box-shadow .15s ease, border-color .15s ease;
  }
  button:hover{ transform: translateY(-1px); box-shadow: 0 10px 22px rgba(17,17,26,.08), 0 3px 8px rgba(17,17,26,.06); }
  button:active{ transform: translateY(0) scale(.98); }
  button.primary{
    background: linear-gradient(90deg, var(--accent), var(--accent-2));
    border-color: transparent; color:white; font-weight:600;
    text-shadow: 0 1px 0 rgba(0,0,0,.12);
  }
  button.ghost{background:rgba(255,255,255,.8)}
  button.warn{background:#fff7e6;border-color:#fde68a;color:#9a6700}
  button.danger{background:#fff1f2;border-color:#fecdd3;color:#b91c1c}
  button:disabled{opacity:.6; cursor:not-allowed}

  table{
    width:100%; border-collapse:separate; border-spacing:0;
    border:1px solid var(--border); border-radius:16px; overflow:hidden;
    background:#fff;
  }
  thead th{
    position:sticky; top:0; background:linear-gradient(180deg,#fafbff,#f3f6ff);
    border-bottom:1px solid var(--border); font-weight:600; padding:12px; text-align:left;
  }
  tbody td{border-bottom:1px solid var(--border); padding:10px; vertical-align:middle}
  tbody tr:last-child td{border-bottom:none}
  tbody tr:hover{background:#fafcff}
  td.center,th.center{text-align:center}

  /* compact money inputs, let notes breathe */
  .money{width:92px}
  .phone{width:170px}
  .notes{min-width:320px}

  .totals{display:flex;gap:16px;justify-content:flex-end;margin-top:12px}
  .totals .pill{background:#fff}

  /* Modal */
  .modal-backdrop{position:fixed;inset:0;background:rgba(10,12,16,.35);display:none;align-items:center;justify-content:center;z-index:20;backdrop-filter: blur(3px)}
  .modal{width:min(420px,95vw);background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px;box-shadow: var(--shadow)}
  .modal-header{display:flex;align-items:center;justify-content:space-between;margin-bottom:10px}
</style>
</head>
<body>
<div class="wrap">
  <div class="bar">
    <h1>AT&amp;T Billing</h1>
    <span id="billDateBadge" class="pill"></span>
    <div class="spacer"></div>
    <button id="configBtn" class="ghost dim" title="Configure people">Config</button>
    <button id="prevBtn" class="ghost">◀ Prev</button>
    <button id="nextBtn" class="ghost">Next ▶</button>
    <button id="billGenBtn" class="primary" title="Pick next bill date and create next bill">Bill generated</button>
    <button id="undoBtn" class="ghost" title="Undo last bill generation">Undo</button>
    <button id="saveWebBtn" class="primary">Save to Web</button>
  </div>

  <div class="card" style="margin-bottom:14px">
    <h2>Bill</h2>
    <label class="small">Bill Amount (for this bill)</label>
    <input id="billAmount" type="number" step="0.01" min="0" placeholder="0.00" class="money" />
  </div>

  <div class="card">
    <h2 style="margin-bottom:10px">Lines (from Config &amp; dates)</h2>
    <div style="overflow:auto">
      <table>
        <thead>
          <tr>
            <th class="center">Informed?</th>
            <th>Sr_no</th>
            <th>Name</th>
            <th>Ph_no</th>
            <th>Amount</th>
            <th>Previous Due</th>
            <th>Balance_due</th>
            <th>Notes</th>
          </tr>
        </thead>
        <tbody id="tbody"></tbody>
      </table>
    </div>
    <div class="totals">
      <span class="pill">Total Amount: <b id="totalAmount">0.00</b></span>
      <span class="pill">Total Balance Due: <b id="totalDue">0.00</b></span>
    </div>
  </div>
</div>

<!-- Pick Next Bill Date Modal -->
<div id="dateModal" class="modal-backdrop">
  <div class="modal">
    <div class="modal-header">
      <h2 style="margin:0">Next bill date</h2>
      <button id="dmClose" class="ghost">✕</button>
    </div>
    <label class="small">Choose the bill date for the <b>next</b> bill page</label>
    <input id="dmInput" type="date" />
    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="dmCancel" class="ghost">Cancel</button>
      <button id="dmOK" class="primary">Create</button>
    </div>
  </div>
</div>

<!-- Config Modal -->
<div id="configModal" class="modal-backdrop">
  <div class="modal" style="width:min(980px,95vw)">
    <div class="modal-header">
      <h2 style="margin:0">Config – People</h2>
      <button id="cfgClose" class="ghost">✕</button>
    </div>

    <div class="row" style="margin-bottom:8px">
      <button id="cfgAdd" class="ghost">+ Add Person</button>
      <span class="muted">Active when <b>Archive_month/year</b> is empty and bill’s month ≥ <b>Active_month/year</b>. “Archive → next” sets archive to the <b>next month of the current bill date</b>.</span>
    </div>

    <div class="sectionTitle">Active</div>
    <div style="overflow:auto; max-height:34vh;">
      <table>
        <thead>
          <tr>
            <th>Sr_No</th>
            <th>Name</th>
            <th>Ph_No</th>
            <th>Active_month/year</th>
            <th>Archive_month/year</th>
            <th class="center">Archive → next</th>
            <th class="center">Delete</th>
          </tr>
        </thead>
        <tbody id="cfgActiveBody"></tbody>
      </table>
    </div>

    <div class="sectionTitle">Archived</div>
    <div style="overflow:auto; max-height:34vh;">
      <table>
        <thead>
          <tr>
            <th>Sr_No</th>
            <th>Name</th>
            <th>Ph_No</th>
            <th>Active_month/year</th>
            <th>Archive_month/year</th>
            <th class="center">Delete</th>
          </tr>
        </thead>
        <tbody id="cfgArchivedBody"></tbody>
      </table>
    </div>

    <div class="row" style="margin-top:10px;justify-content:flex-end">
      <button id="cfgSave" class="primary">Done</button>
    </div>
  </div>
</div>

<script>
/* ===== EDIT THESE for “Save to Web” (2 files) ===== */
const OWNER       = 'coderMikhael';
const REPO        = 'billm';
const BRANCH      = 'main';
const PATH_STATE  = 'data/att-billing.json';   // bills: amounts/balances/notes + bill dates
const PATH_CONFIG = 'data/att-config.json';    // central people config
const TOKEN       = ''; // ← paste your GitHub Fine-Grained PAT locally; leave blank if you won't use "Save to Web"
/* ================================================ */

/* ---- First bill date (seed) ---- */
const FIRST_BILL_DATE = '2024-12-12'; // your first AT&T bill date

const STORAGE_STATE  = 'att.billing.state.v13';
const STORAGE_CONFIG = 'att.billing.config.v9';
const FILE_SCHEMA_VERSION = 1;

/* ---- Helpers ---- */
function pad(n){ return String(n).padStart(2,'0'); }
function toISODate(d){ return `${d.getFullYear()}-${pad(d.getMonth()+1)}-${pad(d.getDate())}`; }
function isoToHuman(iso){
  if(!iso) return 'Bill date: —';
  const d = new Date(iso+'T12:00:00');
  return 'Bill date: ' + d.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'});
}
function monthKeyFromISO(iso){
  const d = iso ? new Date(iso+'T12:00:00') : new Date();
  return `${d.getFullYear()}-${pad(d.getMonth()+1)}`;
}
function nextMonthKeyFromISO(iso){
  const d = iso ? new Date(iso+'T12:00:00') : new Date();
  const n = new Date(d.getFullYear(), d.getMonth()+1, 1);
  return `${n.getFullYear()}-${pad(n.getMonth()+1)}`;
}

/* ---- Data ----
STATE.json {
  version,
  bills: [ { id, billDate:'YYYY-MM-DD'|null, billAmount, rows:[ {personKey, informed, amount, prevDue, balance, notes, _prevFromBillId?} ] } ]
}
CONFIG.json { version, people:[ {sr_no, name, phone, activeFrom:'YYYY-MM', archiveFrom:'YYYY-MM'|null} ] }
personKey = phone (unique)
-------------------------------------------------------- */
function newState(){ return { version:FILE_SCHEMA_VERSION, bills:[] }; }
function newConfig(){ return { version:FILE_SCHEMA_VERSION, people:[] }; }

let STATE  = loadJSON(STORAGE_STATE)  || newState();
let CONFIG = loadJSON(STORAGE_CONFIG) || newConfig();
let currentIndex = 0; // index into STATE.bills

/* ---- Storage ---- */
function loadJSON(k){ try{ return JSON.parse(localStorage.getItem(k)); }catch{return null} }
function saveJSON(k,v){ localStorage.setItem(k, JSON.stringify(v)); }

/* ---- GitHub Contents API ---- */
async function repoGetFile(ownerRepo, path, branch){
  const res = await fetch(`https://api.github.com/repos/${ownerRepo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, {
    headers: TOKEN ? {Authorization:'Bearer '+TOKEN, Accept:'application/vnd.github+json'} : {Accept:'application/vnd.github+json'}
  });
  if(res.status===404) return null;
  if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error((j.message||'HTTP '+res.status)); }
  return res.json();
}
async function repoPutFile(ownerRepo, path, branch, content, sha, message){
  const body = { message: message || 'Save ATT billing data', content: btoa(unescape(encodeURIComponent(content))), branch };
  if(sha) body.sha = sha;
  const res = await fetch(`https://api.github.com/repos/${ownerRepo}/contents/${encodeURIComponent(path)}?ref=${encodeURIComponent(branch)}`, {
    method:'PUT', headers:{Authorization: TOKEN?('Bearer '+TOKEN):undefined, Accept:'application/vnd.github+json'}, body: JSON.stringify(body)
  });
  if(!res.ok){ const j=await res.json().catch(()=>({})); throw new Error((j.message||'HTTP '+res.status)); }
  return res.json();
}

/* ---- DOM ---- */
const el = {
  billDateBadge: document.getElementById('billDateBadge'),
  billAmount: document.getElementById('billAmount'),
  tbody:      document.getElementById('tbody'),
  totalAmount:document.getElementById('totalAmount'),
  totalDue:   document.getElementById('totalDue'),

  prevBtn: document.getElementById('prevBtn'),
  nextBtn: document.getElementById('nextBtn'),
  billGenBtn: document.getElementById('billGenBtn'),
  undoBtn: document.getElementById('undoBtn'),
  saveWebBtn: document.getElementById('saveWebBtn'),

  // date modal
  dateModal: document.getElementById('dateModal'),
  dmInput:   document.getElementById('dmInput'),
  dmOK:      document.getElementById('dmOK'),
  dmCancel:  document.getElementById('dmCancel'),
  dmClose:   document.getElementById('dmClose'),

  // config
  configBtn:  document.getElementById('configBtn'),
  configModal:document.getElementById('configModal'),
  cfgClose:   document.getElementById('cfgClose'),
  cfgAdd:     document.getElementById('cfgAdd'),
  cfgActiveBody:   document.getElementById('cfgActiveBody'),
  cfgArchivedBody: document.getElementById('cfgArchivedBody'),
  cfgSave:    document.getElementById('cfgSave'),
};

/* ---- Rules ---- */
function personActiveForBill(p, billISO){
  const billKey = monthKeyFromISO(billISO); // YYYY-MM
  const aFrom = p.activeFrom || '0000-01';
  const aStop = p.archiveFrom || null;
  const started = (aFrom <= billKey);
  const notStopped = (aStop === null) || (billKey < aStop); // disappear starting archiveFrom month
  return started && notStopped;
}

/* Ensure a bill exists by index */
function ensureBill(idx){
  if(!STATE.bills[idx]){
    const prev = STATE.bills[idx-1];
    STATE.bills[idx] = {
      id: (prev?.id || 0) + 1,
      billDate: null,
      billAmount: 0,
      rows: []
    };
  }
}

/* Build rows from CONFIG; compute prevDue from previous bill's balance */
function ensureRowsFromConfig(idx){
  const bill = STATE.bills[idx];
  if(!bill.rows) bill.rows = [];

  const prevMap = Object.fromEntries(bill.rows.map(r=>[r.personKey, r]));

  // people active for this bill (by this bill's billDate month; if not set, use today's month)
  const activePeople = (CONFIG.people||[])
    .filter(p=>personActiveForBill(p, bill.billDate || toISODate(new Date())))
    .sort((a,b)=>(Number(a.sr_no||0)-Number(b.sr_no||0)));

  const prevBill = (idx>0) ? STATE.bills[idx-1] : null;
  const prevRows = prevBill ? (prevBill.rows||[]) : [];

  bill.rows = activePeople.map(p=>{
    const pk = (p.phone||'').trim(); // PHONE is the key (make unique)
    const existing = prevMap[pk] || {};
    let prevDue = existing.prevDue;

    if(prevDue === undefined || existing._prevFromBillId !== (prevBill?.id ?? null)){
      const prevRow = prevRows.find(rr => rr.personKey === pk);
      prevDue = prevRow ? Number(prevRow.balance||0) : 0;
    }
    const amount = existing.amount ?? 0;
    const balance = Number(amount||0) + Number(prevDue||0);
    return {
      personKey: pk,
      informed: !!existing.informed,
      amount: Number(amount||0),
      prevDue: Number(prevDue||0),
      balance: Number(balance||0),
      notes: existing.notes || '',
      _prevFromBillId: prevBill ? prevBill.id : null
    };
  });
}

/* ---- Render ---- */
function render(){
  const bill = STATE.bills[currentIndex];
  el.billDateBadge.textContent = isoToHuman(bill.billDate);

  // controls
  el.prevBtn.disabled = (currentIndex === 0);
  el.nextBtn.disabled = (currentIndex >= STATE.bills.length-1); // no later bill
  // You can generate next when you're on the latest bill and (option A) you want to set next date — always allowed.
  const onLatest = (currentIndex === STATE.bills.length-1);
  el.billGenBtn.disabled = !onLatest;

  // Undo allowed if we are on latest and there exists a previous bill (i.e., we can drop the newest bill)
  el.undoBtn.disabled = !(onLatest && STATE.bills.length >= 2);

  ensureRowsFromConfig(currentIndex);
  el.billAmount.value = bill.billAmount ?? 0;

  renderRows();
  updateTotals();
}

function renderRows(){
  const bill = STATE.bills[currentIndex];
  const rows = bill.rows || [];

  // join with CONFIG by phone
  const byPhone = Object.create(null);
  (CONFIG.people||[]).forEach(p=>{ byPhone[(p.phone||'').trim()] = p; });

  el.tbody.innerHTML = '';
  rows.forEach((r, i)=>{
    const p = byPhone[r.personKey] || {};
    const tr = document.createElement('tr');

    // Informed
    const tdInf = document.createElement('td'); tdInf.className='center';
    const cb = document.createElement('input'); cb.type='checkbox'; cb.checked = !!r.informed;
    cb.addEventListener('change', ()=>{ r.informed=cb.checked; saveJSON(STORAGE_STATE, STATE); });
    tdInf.appendChild(cb);

    // Sr_no sequential
    const tdSr  = document.createElement('td'); tdSr.textContent = String(i+1);

    // Name / Phone
    const tdNm  = document.createElement('td'); tdNm.textContent = p.name || '';
    const tdPh  = document.createElement('td'); tdPh.textContent = p.phone || r.personKey || '';

    // Amount
    const tdAmt = document.createElement('td');
    const amt = document.createElement('input'); amt.type='number'; amt.step='0.01'; amt.min='0'; amt.className='money'; amt.value=r.amount ?? 0;
    amt.addEventListener('input', ()=>{ r.amount=parseFloat(amt.value||'0'); r.balance = Number(r.amount||0)+Number(r.prevDue||0); saveJSON(STORAGE_STATE, STATE); updateTotals(); });
    tdAmt.appendChild(amt);

    // Previous Due
    const tdPrev = document.createElement('td');
    const pd = document.createElement('input'); pd.type='number'; pd.step='0.01'; pd.min='0'; pd.className='money'; pd.value=r.prevDue ?? 0;
    pd.addEventListener('input', ()=>{ r.prevDue=parseFloat(pd.value||'0'); r.balance = Number(r.amount||0)+Number(r.prevDue||0); saveJSON(STORAGE_STATE, STATE); updateTotals(); });
    tdPrev.appendChild(pd);

    // Balance Due (read-only; amount + prevDue)
    const tdBal = document.createElement('td');
    const bal = document.createElement('input'); bal.type='number'; bal.step='0.01'; bal.min='0'; bal.className='money'; bal.value=r.balance ?? 0; bal.readOnly = true;
    const syncBal = ()=>{ bal.value = (Number(r.amount||0)+Number(r.prevDue||0)).toFixed(2); };
    syncBal();
    tdBal.appendChild(bal);

    // Notes
    const tdNt  = document.createElement('td');
    const nt = document.createElement('input'); nt.type='text'; nt.className='notes'; nt.placeholder='Notes'; nt.value=r.notes||'';
    nt.addEventListener('input', ()=>{ r.notes=nt.value; saveJSON(STORAGE_STATE, STATE); });
    tdNt.appendChild(nt);

    tr.append(tdInf, tdSr, tdNm, tdPh, tdAmt, tdPrev, tdBal, tdNt);
    el.tbody.appendChild(tr);
  });
}

function updateTotals(){
  const rows = STATE.bills[currentIndex].rows || [];
  const totAmt = rows.reduce((s,r)=>s+Number(r.amount||0),0);
  rows.forEach(r=>{ r.balance = Number(r.amount||0)+Number(r.prevDue||0); });
  const totDue = rows.reduce((s,r)=>s+Number(r.balance||0),0);
  el.totalAmount.textContent = totAmt.toFixed(2);
  el.totalDue.textContent    = totDue.toFixed(2);
}

/* ---- Events: top bar ---- */
el.prevBtn.addEventListener('click', ()=>{
  if(currentIndex>0){ currentIndex--; render(); saveJSON(STORAGE_STATE, STATE); }
});
el.nextBtn.addEventListener('click', ()=>{
  if(currentIndex < STATE.bills.length-1){ currentIndex++; render(); saveJSON(STORAGE_STATE, STATE); }
});
el.billGenBtn.addEventListener('click', ()=>{
  // Open date-picker modal; date chosen becomes NEXT bill's billDate
  const todayISO = toISODate(new Date());
  el.dmInput.value = todayISO;
  el.dateModal.style.display = 'flex';
});
el.dmClose.addEventListener('click', ()=> el.dateModal.style.display='none');
el.dmCancel.addEventListener('click', ()=> el.dateModal.style.display='none');
el.dmOK.addEventListener('click', ()=>{
  const chosen = el.dmInput.value;
  if(!chosen){ alert('Please pick a date.'); return; }

  // Create next bill stamped with chosen date; keep current bill as-is
  const curr = STATE.bills[currentIndex];
  const nextId = (curr?.id || 0) + 1;
  STATE.bills.push({
    id: nextId,
    billDate: chosen,
    billAmount: 0,
    rows: []
  });
  currentIndex = STATE.bills.length - 1;

  // Build rows (pull prevDue from previous bill)
  ensureRowsFromConfig(currentIndex);

  saveJSON(STORAGE_STATE, STATE);
  el.dateModal.style.display='none';
  render();
});

el.undoBtn.addEventListener('click', ()=>{
  // Undo = delete the latest bill and go back
  if(currentIndex === STATE.bills.length-1 && STATE.bills.length >= 2){
    STATE.bills.pop();
    currentIndex = STATE.bills.length - 1;
    saveJSON(STORAGE_STATE, STATE);
    render();
  }
});
el.billAmount.addEventListener('input', ()=>{
  const b = STATE.bills[currentIndex];
  b.billAmount = parseFloat(el.billAmount.value||'0');
  saveJSON(STORAGE_STATE, STATE);
});

/* ---- Config Modal ---- */
el.configBtn.addEventListener('click', ()=>{ renderConfigTables(); el.configModal.style.display='flex'; });
el.cfgClose.addEventListener('click', ()=> el.configModal.style.display='none');
el.cfgSave.addEventListener('click', ()=>{
  saveJSON(STORAGE_CONFIG, CONFIG);
  ensureRowsFromConfig(currentIndex);
  saveJSON(STORAGE_STATE, STATE);
  render();
  el.configModal.style.display='none';
});
el.cfgAdd.addEventListener('click', ()=>{
  CONFIG.people.push({
    sr_no: (CONFIG.people.length+1),  // Active will render as 1..N
    name:'', phone:'',
    activeFrom: monthKeyFromISO(null), // current month
    archiveFrom: null
  });
  saveJSON(STORAGE_CONFIG, CONFIG);
  renderConfigTables();
});

function renderConfigTables(){
  const active = [], archived = [];
  (CONFIG.people||[]).forEach(p => (p.archiveFrom ? archived : active).push(p));
  active.sort((a,b)=>(Number(a.sr_no||0)-Number(b.sr_no||0)));

  const currISO = STATE.bills[currentIndex]?.billDate || toISODate(new Date());

  document.getElementById('cfgActiveBody').innerHTML = '';
  document.getElementById('cfgArchivedBody').innerHTML = '';

  // ACTIVE: 1..N (no gaps)
  active.forEach((p, idx)=>{
    const tr = document.createElement('tr');

    const tdSr = document.createElement('td'); tdSr.textContent = String(idx+1); tr.appendChild(tdSr);

    tr.appendChild(cfgTextCell(p, 'name', 'Full name'));
    tr.appendChild(cfgTextCell(p, 'phone', '555-123-4567', 'phone'));

    tr.appendChild(cfgMonthCell(p, 'activeFrom'));
    tr.appendChild(cfgMonthCell(p, 'archiveFrom', ()=>{ renderConfigTables(); }));

    // Archive → next month relative to current bill date
    const tdArc = document.createElement('td'); tdArc.className='center';
    const ab = document.createElement('button'); ab.textContent='Archive'; ab.className='warn';
    ab.title='Move to Archived (from next month of current bill date)';
    ab.addEventListener('click', ()=>{
      p.archiveFrom = nextMonthKeyFromISO(currISO);
      saveJSON(STORAGE_CONFIG, CONFIG);
      renderConfigTables();
      ensureRowsFromConfig(currentIndex);
      saveJSON(STORAGE_STATE, STATE);
      render();
    });
    tdArc.appendChild(ab);
    tr.appendChild(tdArc);

    // Delete
    const tdDel = document.createElement('td'); tdDel.className='center';
    const db = document.createElement('button'); db.textContent='Delete'; db.className='danger';
    db.title='Remove from config (history stays in past bills)';
    db.addEventListener('click', ()=>{
      if(confirm(`Delete ${p.name || p.phone || 'this person'} from config? This does not change past bills.`)){
        const i = CONFIG.people.indexOf(p);
        if(i>=0){ CONFIG.people.splice(i,1); saveJSON(STORAGE_CONFIG, CONFIG); renderConfigTables(); ensureRowsFromConfig(currentIndex); saveJSON(STORAGE_STATE, STATE); render(); }
      }
    });
    tdDel.appendChild(db);
    tr.appendChild(tdDel);

    document.getElementById('cfgActiveBody').appendChild(tr);
  });

  // ARCHIVED
  archived.forEach((p, idx)=>{
    const tr = document.createElement('tr');
    const tdSr = document.createElement('td'); tdSr.textContent = String(idx+1); tr.appendChild(tdSr);

    tr.appendChild(cfgTextCell(p, 'name', 'Full name'));
    tr.appendChild(cfgTextCell(p, 'phone', '555-123-4567', 'phone'));
    tr.appendChild(cfgMonthCell(p, 'activeFrom'));
    tr.appendChild(cfgMonthCell(p, 'archiveFrom', ()=>{ renderConfigTables(); }));

    // Delete
    const tdDel = document.createElement('td'); tdDel.className='center';
    const db = document.createElement('button'); db.textContent='Delete'; db.className='danger';
    db.title='Remove from config (history stays in past bills)';
    db.addEventListener('click', ()=>{
      if(confirm(`Delete ${p.name || p.phone || 'this person'} from config? This does not change past bills.`)){
        const i = CONFIG.people.indexOf(p);
        if(i>=0){ CONFIG.people.splice(i,1); saveJSON(STORAGE_CONFIG, CONFIG); renderConfigTables(); ensureRowsFromConfig(currentIndex); saveJSON(STORAGE_STATE, STATE); render(); }
      }
    });
    tdDel.appendChild(db);
    tr.appendChild(tdDel);

    document.getElementById('cfgArchivedBody').appendChild(tr);
  });
}

// cells
function cfgTextCell(obj, key, placeholder, cls){
  const td = document.createElement('td');
  const inp = document.createElement('input');
  inp.type='text'; if(cls) inp.className=cls;
  inp.placeholder = placeholder || '';
  inp.value = obj[key] || '';
  inp.addEventListener('input', ()=>{ obj[key]=inp.value; saveJSON(STORAGE_CONFIG, CONFIG); });
  td.appendChild(inp);
  return td;
}
function cfgMonthCell(obj, key, onChange){
  const td = document.createElement('td');
  const m = document.createElement('input'); m.type='month'; m.value=(obj[key]||'').slice(0,7);
  m.addEventListener('input', ()=>{
    obj[key] = m.value || null;
    saveJSON(STORAGE_CONFIG, CONFIG);
    if(onChange) onChange();
  });
  td.appendChild(m);
  return td;
}

/* ---- Save to Web (two files) ---- */
async function saveToWeb(){
  if(!OWNER || !REPO || !BRANCH || !TOKEN){ alert('Fill OWNER/REPO/BRANCH/TOKEN at top.'); return; }
  const ownerRepo = `${OWNER}/${REPO}`;
  // STATE
  let shaState = null;
  try{ const j = await repoGetFile(ownerRepo, PATH_STATE, BRANCH); if(j && j.sha) shaState=j.sha; }catch{}
  await repoPutFile(ownerRepo, PATH_STATE, BRANCH, JSON.stringify(STATE,null,2), shaState, 'Save ATT billing (state)');
  // CONFIG
  let shaCfg = null;
  try{ const j2 = await repoGetFile(ownerRepo, PATH_CONFIG, BRANCH); if(j2 && j2.sha) shaCfg=j2.sha; }catch{}
  await repoPutFile(ownerRepo, PATH_CONFIG, BRANCH, JSON.stringify(CONFIG,null,2), shaCfg, 'Save ATT billing (config)');
  alert('Saved to web JSON ✅');
}
document.getElementById('saveWebBtn').addEventListener('click', ()=> saveToWeb().catch(e=>alert('Save failed: '+e.message)));

/* ---- Boot & initial seed ---- */
async function tryLoadFromWebOnce(){
  const ownerRepo = (OWNER&&REPO) ? `${OWNER}/${REPO}` : null;
  if(ownerRepo){
    try{
      const st = await repoGetFile(ownerRepo, PATH_STATE, BRANCH);
      if(st?.content){
        const s = JSON.parse(decodeURIComponent(escape(atob(st.content))));
        if(s.version===FILE_SCHEMA_VERSION) STATE = s;
      }
    }catch{}
    try{
      const cf = await repoGetFile(ownerRepo, PATH_CONFIG, BRANCH);
      if(cf?.content){
        const c = JSON.parse(decodeURIComponent(escape(atob(cf.content))));
        if(c.version===FILE_SCHEMA_VERSION) CONFIG = c;
      }
    }catch{}
  }

  if(!STATE.bills || STATE.bills.length===0){
    STATE.bills = [
      { id: 1, billDate: FIRST_BILL_DATE, billAmount: 0, rows: [] }, // first bill stamped
      { id: 2, billDate: null, billAmount: 0, rows: [] }             // a blank next bill to start with
    ];
  }
  currentIndex = STATE.bills.length-1; // show latest

  // ensure rows exist for current
  ensureRowsFromConfig(currentIndex);
  saveJSON(STORAGE_STATE, STATE);
  if(!CONFIG.people) CONFIG.people = [];
  saveJSON(STORAGE_CONFIG, CONFIG);
}

/* ---- Start ---- */
(async function init(){
  await tryLoadFromWebOnce();
  render();
})();
</script>
</body>
</html>
